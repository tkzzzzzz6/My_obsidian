-- ===========================================
-- 商品表和销售表定义 + 利润分析函数
-- 知识点：表值函数、多语句表值函数、JOIN查询、聚合函数、排序
-- ===========================================

-- 1. 商品表定义
-- 存储商品的基本信息，包括商品号、商品名、类别和进货单价
CREATE TABLE 商品表 (
    商品号 char(10) PRIMARY KEY,        -- 商品编号，主键，固定长度10字符
    商品名 varchar(40),                 -- 商品名称，可变长度，最多40字符
    类别 varchar(20),                   -- 商品类别，可变长度，最多20字符
    进货单价 int                        -- 进货单价，整数类型
);

-- 2. 销售表定义  
-- 存储商品的销售记录，包括销售时间、数量、单价等信息
CREATE TABLE 销售表 (
    商品号 char(10),                    -- 商品编号，外键，引用商品表的商品号
    销售时间 datetime,                  -- 销售时间，日期时间类型
    销售数量 int,                       -- 销售数量，整数类型
    销售单价 int,                       -- 销售单价，整数类型
    PRIMARY KEY(商品号, 销售时间)        -- 复合主键：商品号+销售时间，确保同一商品在同一时间只能有一条销售记录
);

-- ===========================================
-- 用户定义的多语句表值函数：f_Profit
-- 功能：根据商品类别计算2012年每种商品的总利润，并按利润降序排列
-- 参数：@lb - 商品类别
-- 返回：表值结果集，包含商品号和总利润
-- ===========================================

CREATE FUNCTION f_Profit (@lb char(10))  -- 定义函数，参数@lb为商品类别，char(10)类型
RETURNS TABLE                            -- 51. 返回类型：表值函数，返回TABLE类型
AS 
BEGIN
    -- 声明表变量，用于存储计算结果
    DECLARE @ProfitTable AS TABLE (      -- 52. 声明表变量@ProfitTable，AS关键字
        商品号 char(10),                 -- 商品编号字段
        总利润 int                       -- 总利润字段
    );
    
    -- 向表变量插入计算结果
    INSERT INTO @ProfitTable             -- 开始插入数据到表变量
    SELECT 
        商品表.商品号,                    -- 选择商品号
        SUM((销售表.销售单价 - 商品表.进货单价) * 销售表.销售数量) AS 总利润  -- 53. 计算总利润：(销售单价-进货单价)*销售数量，然后求和
    FROM 商品表                          -- 从商品表开始
    INNER JOIN 销售表 ON 商品表.商品号 = 销售表.商品号  -- 内连接销售表，通过商品号关联
    WHERE 商品表.类别 = @lb              -- 筛选指定类别的商品
        AND YEAR(销售表.销售时间) = 2012  -- 筛选2012年的销售记录
    GROUP BY 商品表.商品号;              -- 按商品号分组，计算每种商品的总利润
    
    -- 返回结果，按总利润降序排列
    RETURN SELECT 商品号, 总利润 FROM @ProfitTable ORDER BY 总利润 DESC;  -- 54. 返回结果集，按总利润降序排列
END;

-- ===========================================
-- 相关知识点说明：
-- ===========================================
-- 1. 表值函数 (Table-Valued Function)
--    - 返回TABLE类型的结果集
--    - 可以在SELECT语句中像表一样使用
--    - 分为内联表值函数和多语句表值函数

-- 2. 多语句表值函数特点：
--    - 使用BEGIN...END块
--    - 可以声明表变量
--    - 可以包含复杂的业务逻辑
--    - 最后使用RETURN语句返回结果

-- 3. 内连接 (INNER JOIN)
--    - 只返回两个表中都有匹配记录的行
--    - 确保商品表和销售表的数据完整性

-- 4. 聚合函数 (SUM)
--    - 对分组后的数据进行求和
--    - 必须与GROUP BY子句配合使用

-- 5. 日期函数 (YEAR)
--    - 提取日期时间字段的年份部分
--    - 用于按年份筛选数据

-- 6. 复合主键
--    - 由多个字段组成的主键
--    - 确保记录的唯一性
--    - 在销售表中防止同一商品在同一时间有多条记录
