/*-----------------------------------------------------------------------------
题目背景（作为说明注释）：
有一个图书管理数据库，含三张表：
1) 图书明细表： (图书编号, 图书类别, 图书名称, 作者, 出版社, 出版日期, 定价)
2) 读者表    ： (借书证号, 姓名, 系别, 办证日期)
3) 借出信息表： (借出编号, 借书证号, 图书编号, 借书日期)

要求：定义一个“多语句表值函数”，仅提供参数“借书证号”，
      调用后返回该读者的借书情况；若有借书，返回
      [图书编号、书籍名称、定价、借书日期]；若没有，则返回空记录集。
函数名：f_BorrowBook(@jszh char(20))。
说明：以下实现为 SQL Server / T-SQL 版本（使用方括号标识中文对象名）。
-----------------------------------------------------------------------------*/

-- 若已存在同名函数则先删除（SQL Server 2016+ 可用）
IF OBJECT_ID(N'dbo.f_BorrowBook', N'IF') IS NOT NULL
    DROP FUNCTION dbo.f_BorrowBook;
GO

-- 创建函数：输入借书证号，输出借阅清单
CREATE FUNCTION dbo.f_BorrowBook (@jszh CHAR(20))
RETURNS @Borrowed TABLE
(
    [图书编号]   NVARCHAR(50),
    [书籍名称]   NVARCHAR(200),
    [定价]       DECIMAL(10,2),
    [借书日期]   DATE
)
AS
BEGIN
    /* 将匹配到的借阅记录写入返回表变量
       说明：
       - 直接连接 [借出信息表] 与 [图书明细表]
       - 若该证号无任何借阅记录，INSERT 影响行数为 0，函数返回空集
       - 列类型长度可按实际表结构调整
    */
    INSERT INTO @Borrowed([图书编号], [书籍名称], [定价], [借书日期])
    SELECT
        b.[图书编号],
        b.[图书名称],
        b.[定价],
        l.[借书日期]
    FROM [dbo].[借出信息表] AS l
    INNER JOIN [dbo].[图书明细表] AS b
        ON l.[图书编号] = b.[图书编号]
    WHERE l.[借书证号] = @jszh;

    RETURN;
END
GO

/*--------------------------- 使用示例与建议 ---------------------------
-- 查询某借书证号的借阅情况：
SELECT * FROM dbo.f_BorrowBook('JS000123');

-- 性能建议（可选，按你数据库实际情况建立）：
-- 1) 借出信息表：建议建立索引 (借书证号) 或 (借书证号, 图书编号)
-- 2) 图书明细表：建议以 图书编号 为主键/唯一索引

-- 示例：
-- CREATE INDEX IX_借出信息表_借书证号 ON [dbo].[借出信息表]([借书证号]);
-- CREATE UNIQUE INDEX UX_图书明细表_图书编号 ON [dbo].[图书明细表]([图书编号]);

-- 备注：
-- 若需要把“未归还过滤、逾期等逻辑”加入结果，可在 INSERT 的 SELECT 子句上追加条件。
---------------------------------------------------------------------*/
